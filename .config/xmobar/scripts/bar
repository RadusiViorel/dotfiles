#!/usr/bin/env bash

COM="${HOME}/.config/xmobar/com"

CACHE_DIR="${HOME}/.config/xmobar/.cache"
STATE_FILE="${HOME}/.config/xmobar/scripts/state"
CACHE_FILE="${CACHE_DIR}/bar_output"
TRIGGER_FILE="${CACHE_DIR}/refresh_trigger"

spinner_active=0
# Check for any *_loading=1 in state file
if grep -q "^[a-z_]*_loading=1$" "$STATE_FILE"; then
  spinner_active=1
fi

# Fast path: if cache exists and is newer than trigger AND no spinner is active, just output it
if [[ $spinner_active -eq 0 && -f "$CACHE_FILE" && -f "$TRIGGER_FILE" && "$CACHE_FILE" -nt "$TRIGGER_FILE" ]]; then
  cat "$CACHE_FILE"
  exit 0
fi

set -a  # Auto-export all variables
source "${HOME}/.config/xmobar/scripts/vars"
source "${HOME}/.config/xmobar/scripts/state"
set +a

mkdir -p "${CACHE_DIR}"
[[ ! -f "$TRIGGER_FILE" ]] && touch "$TRIGGER_FILE"

components=(
  "capslock"
  "updates"
  "volume:<fc="$COLOR_MUTE">ó°œ¥</fc>"
  "volume_output"
  "brightness"
  "bluetooth"
  "battery"
  "space"
  "vpn"
  "network"
  "cpu_temp"
  "sys_usage"
  "weather"
  "speedtest"
  "rofi_theme"
  "yt_dl"
  "wallpaper"
  "screenshot"
  "automount"
  "page"
  "calendar"
  "power"
)

bar=""
for c in "${components[@]}"; do
  IFS=':' read -r component sep <<< "$c"
  bar+="$("$COM/$component/render" "--sep=$sep")"
done

printf '%s\n' "$bar" | tee "$CACHE_FILE"
