#!/usr/bin/env bash

# Output caching system for xmobar components
# Provides TTL-based caching to reduce redundant renders and command execution

CACHE_DIR="${HOME}/.config/xmobar/.cache"
mkdir -p "$CACHE_DIR"

# cache_get <component_name> <ttl_seconds>
# Returns cached output if valid, exits with code 1 if cache miss/expired
cache_get() {
  local component="$1"
  local ttl="$2"
  local cache_file="${CACHE_DIR}/${component}"
  local timestamp_file="${CACHE_DIR}/${component}.ts"

  [[ -f "$cache_file" ]] && [[ -f "$timestamp_file" ]] || return 1

  local cached_ts
  cached_ts=$(cat "$timestamp_file" 2>/dev/null) || return 1
  local now
  now=$(date +%s)

  (( now - cached_ts < ttl )) || return 1

  cat "$cache_file"
  return 0
}

# cache_set <component_name> <output>
# Stores output and timestamp
cache_set() {
  local component="$1"
  local output="$2"
  local cache_file="${CACHE_DIR}/${component}"
  local timestamp_file="${CACHE_DIR}/${component}.ts"

  printf '%s' "$output" > "$cache_file"
  date +%s > "$timestamp_file"
}

# cache_cmd <cache_key> <ttl_seconds> <command...>
# Caches command output with TTL
cache_cmd() {
  local cache_key="$1"
  local ttl="$2"
  shift 2

  if cache_get "cmd_${cache_key}" "$ttl"; then
    return 0
  fi

  local output
  output=$("$@")
  cache_set "cmd_${cache_key}" "$output"
  printf '%s' "$output"
}
