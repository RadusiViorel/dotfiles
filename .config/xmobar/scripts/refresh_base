#!/usr/bin/env bash
# Base functions for component-specific refresh daemons
# Source this file in component refresh scripts

REFRESH_SCRIPT="${HOME}/.config/xmobar/scripts/refresh"

# Start a component refresh daemon
# Usage: start_refresh_daemon <component_name> <interval_seconds>
start_refresh_daemon() {
  local component_name="$1"
  local interval="$2"

  local pidfile="${HOME}/.config/xmobar/.cache/refresh_${component_name}.pid"

  # Check if daemon already running
  if [[ -f "$pidfile" ]]; then
    local old_pid=$(cat "$pidfile")
    if ps -p "$old_pid" > /dev/null 2>&1; then
      echo "Refresh daemon for $component_name already running (PID: $old_pid)"
      return 0
    fi
  fi

  # Start daemon in background
  (
    # Write PID after backgrounding to get correct PID
    trap "rm -f $pidfile" EXIT
    
    while true; do
      sleep "$interval"
      "$REFRESH_SCRIPT" 2>/dev/null
    done
  ) &
  
  local daemon_pid=$!
  echo "$daemon_pid" > "$pidfile"
  echo "Started refresh daemon for $component_name (interval: ${interval}s, PID: $daemon_pid)"
}

# Stop a component refresh daemon
# Usage: stop_refresh_daemon <component_name>
stop_refresh_daemon() {
  local component_name="$1"
  local pidfile="${HOME}/.config/xmobar/.cache/refresh_${component_name}.pid"

  if [[ -f "$pidfile" ]]; then
    local pid=$(cat "$pidfile")
    if ps -p "$pid" > /dev/null 2>&1; then
      kill "$pid"
      rm -f "$pidfile"
      echo "Stopped refresh daemon for $component_name (PID: $pid)"
    else
      rm -f "$pidfile"
      echo "Daemon for $component_name not running (stale pidfile removed)"
    fi
  else
    echo "No daemon running for $component_name"
  fi
}

# Check if daemon is running
# Usage: is_daemon_running <component_name>
is_daemon_running() {
  local component_name="$1"
  local pidfile="${HOME}/.config/xmobar/.cache/refresh_${component_name}.pid"

  if [[ -f "$pidfile" ]]; then
    local pid=$(cat "$pidfile")
    if ps -p "$pid" > /dev/null 2>&1; then
      return 0
    fi
  fi
  return 1
}

# Generic refresh daemon handler
# Automatically detects component name from script path
# Usage: handle_refresh_daemon <interval_seconds> "$@"
handle_refresh_daemon() {
  local interval="$1"
  shift
  local action="$1"

  # Get component name from script directory
  local component_name=$(basename "$(dirname "$(readlink -f "${BASH_SOURCE[1]}")")")

  case "$action" in
    start) start_refresh_daemon "$component_name" "$interval" ;;
    stop) stop_refresh_daemon "$component_name" ;;
    status) echo "$(echo "$component_name" | sed 's/_/ /g' | sed 's/\b\(.\)/\u\1/g') refresh daemon is $(is_daemon_running "$component_name" && echo "" || echo "not ")running" ;;
    restart) stop_refresh_daemon "$component_name" ; sleep 0.5 ; start_refresh_daemon "$component_name" "$interval" ;;
    *) echo "Usage: $0 {start|stop|status|restart}" ; exit 1 ;;
  esac
}
