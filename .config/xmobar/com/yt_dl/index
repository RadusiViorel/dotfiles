#!/usr/bin/env bash

source "${HOME}/.config/xmobar/scripts/check_dependency"
check_dependency "yt-dlp"
check_dependency "ffmpeg"

COM="${HOME}/.config/xmobar/com/yt_dl"
[[ -n "$1" ]] && STATE_FILE="${HOME}/.config/xmobar/scripts/state" && source "${STATE_FILE}"
source "${HOME}/.config/xmobar/scripts/page/index" 2

DESTINATION="${HOME}/youtube_dl"

source "${HOME}/.config/xmobar/scripts/state_loader"
state_init "yt_type" "mp4"
state_init "yt_loading_live" 0
state_init "yt_spinner" 0

case "$1" in
  download) ${COM}/actions/download \
    --STATE_FILE=${STATE_FILE}      \
    --destination=${DESTINATION}    \
    --type=${yt_type}               \
    --LOADING_KEY=yt_loading_live   ;;

  toggle) ${COM}/actions/toggle  \
     --STATE_FILE=${STATE_FILE}  \
     --KEY=yt_type               \
     --value=${yt_type}          ;;
  *) ;;
esac

if (( yt_loading_live == 1 )); then
  spinner_icons=(⠋ ⠙ ⠹ ⠸ ⠼ ⠴ ⠦ ⠧ ⠇ ⠏)
  idx=$(( ( yt_spinner + 1 ) % ${#spinner_icons[@]} ))
  state_update "yt_spinner" "$idx"
  echo "<fc=${COLOR_INFO}>${spinner_icons[$idx]} Downloading 󰦗</fc>"
  exit 0
fi

color=$([[ $yt_type == 'mp4' ]] && echo "${COLOR_WHITE}" || echo "${COLOR_WARNING}")
echo "<fc=${color}>󰗃</fc>"
