#!/usr/bin/env bash

COM="${HOME}/.config/xmobar/com/network"
[[ -n "$1" ]] && STATE_FILE="${HOME}/.config/xmobar/scripts/state" && source "${STATE_FILE}"
source "${HOME}/.config/xmobar/scripts/page/index" 1

source "${HOME}/.config/xmobar/scripts/cache"

source "${HOME}/.config/xmobar/scripts/state_loader"
state_init "network_enabled" 1
state_init "network_loading_live" 0
state_init "network_spinner" 0
state_init "network_traffic_live" 0

interface=wlan0
lan_interface=eth0
wifi_name_length=150

# Cache ip link output for 2 seconds and find interfaces in single pass
ip_output=$(cache_cmd "ip_link" 2 ip -o link show)

# Find lan and wireless interfaces in one pass
# Skip virtual interfaces (docker, veth, tun, tap, virbr, etc.)
while IFS=': ' read -r _ iface _; do
  # Skip loopback and virtual interfaces
  if [[ $iface != "lo" ]] && [[ $iface != docker* ]] && [[ $iface != veth* ]] && \
     [[ $iface != br-* ]] && [[ $iface != tun* ]] && [[ $iface != tap* ]] && \
     [[ $iface != virbr* ]]; then
    if [ ! -d "/sys/class/net/$iface/wireless" ]; then
      # Check if this is a physical ethernet interface with carrier
      if [ -f "/sys/class/net/$iface/carrier" ]; then
        carrier=$(cat "/sys/class/net/$iface/carrier" 2>/dev/null || echo 0)
        if [[ $carrier == "1" ]]; then
          lan_interface=$iface
          # Found physical LAN with active connection
          echo "LAN<fc=${COLOR_MUTE}> 󰜥 </fc> 󰈀"
          exit 0
        fi
      fi
    else
      interface=$iface
    fi
  fi
done <<< "$ip_output"

case "$1" in
  connect) ${COM}/actions/connect \
    --interface=${interface}      \
    --STATE_FILE=${STATE_FILE}    \
    --KEY=network_loading_live ;;

  toggle) ${COM}/actions/toggle \
    --interface=${interface}    \
    --STATE_FILE=${STATE_FILE}  \
    --KEY=network_enabled       \
    --value=${network_enabled} ;;

  traffic) ${COM}/actions/traffic \
    --STATE_FILE=${STATE_FILE}    \
    --KEY=network_traffic_live    \
    --value=${network_traffic_live} ;;
  *) ;;
esac

if (( network_enabled == 0 )); then
  echo "<fc=${COLOR_MUTE}>󰤮</fc>"
  exit 0
fi

# Cache wpa_cli status for 2 seconds
ssid=$(cache_cmd "wpa_cli_${interface}" 2 wpa_cli -i ${interface} status | awk -F= '/^ssid/ {print $2}')

if [ ${#ssid} -gt ${wifi_name_length} ]; then
  ssid="${ssid:0:$((wifi_name_length-3))}<fc=${COLOR_MUTE}>󰇘</fc>"
fi

signal_icons=( 󰤯 󰤟 󰤢 󰤥 󰤨 )
signal_thresholds=( 15 33 50 90 )
signal_icon=${signal_icons[-1]}
signal=$(awk 'NR==3 {print $3}' /proc/net/wireless | sed 's/\.//')

for i in "${!signal_thresholds[@]}"; do
  if (( signal < signal_thresholds[i] )); then
    signal_icon="${signal_icons[i]}"
    break
  fi
done

if (( network_loading_live == 1 )); then
  spinner_icons=(⠋ ⠙ ⠹ ⠸ ⠼ ⠴ ⠦ ⠧ ⠇ ⠏)
  idx=$(( ( network_spinner + 1 ) % ${#spinner_icons[@]} ))
  state_update "network_spinner" "${idx}"
  echo "<fc=${COLOR_INFO}>${spinner_icons[$idx]} Searching... 󱛇</fc>"
  exit 0
fi

if (( network_traffic_live == 1 )); then
  traffic="$("${COM}/scripts/traffic/traffic" --interface="$interface")"
  echo "<fc=${COLOR_WHITE}>$ssid ${signal}󰏰 ${signal_icon}</fc>${traffic}"
  exit 0
fi

echo "<fc=${COLOR_WHITE}>$ssid ${signal}󰏰 ${signal_icon}</fc>"
