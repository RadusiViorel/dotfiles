#!/usr/bin/env bash

# Parse named parameters
for arg in "$@"; do
  case $arg in
    --interface=*)  interface="${arg#*=}"  ;;
    --STATE_FILE=*) STATE_FILE="${arg#*=}" ;;
    --KEY=*)        KEY="${arg#*=}"        ;;
    *) echo "Unknown argument: $arg" ; exit 1 ;;
  esac
done

# Enable network display when connecting
# (If user clicked connect, they want to see network info)
sed -i "s/^network_enabled=.*/network_enabled=1/" "$STATE_FILE"

# Set loading state BEFORE scan so spinner shows during WiFi scan
sed -i "s/^$KEY=.*/network_loading=1/" "$STATE_FILE"

# ---------------------------
# 0. Trigger scan explicitly
# ---------------------------
wpa_cli -i "$interface" scan >/dev/null
sleep 2

# Clear loading state before showing rofi
# (Rofi blocks, user doesn't need to see spinner while selecting)
sed -i "s/^network_loading=.*/network_loading=0/" "$STATE_FILE"
sleep 0.5
"${HOME}/.config/xmobar/scripts/refresh"

# ---------------------------
# 1. Build KNOWN SSID LIST
# ---------------------------
known_ssids=$(wpa_cli -i "$interface" list_networks \
  | awk -F '\t' 'NR>1 && $2!="" {print $2}')

# Convert known ssids into easy grep matches
is_known() {
  echo "$known_ssids" | grep -Fxq "$1"
}

# ---------------------------
# 2. Scan Wi-Fi networks
# ---------------------------
scan_list=$(
  wpa_cli -i "$interface" scan_results \
    | tail -n +2 \
    | awk -F'\t' '$5 && $5 !~ /^[[:cntrl:]]+$/ { print $5 }' \
    | sort -u
  )
# ---------------------------
# 3. Build ROFI menu
# ---------------------------
#
menu=""
while IFS= read -r ssid; do
  if is_known "$ssid"; then
    menu+="$ssid 󰦕"$'\n'
  else
    menu+="$ssid"$'\n'
  fi
done <<< "$scan_list"

# Show the menu
chosen=$(echo -en "$menu" | rofi -dmenu -p "Select Wi-Fi")
[ -z "$chosen" ] && (sed -i "s/^$KEY=.*/$KEY=0/" "$STATE_FILE") && exit 0

# Remove trailing '*' if present
ssid="${chosen% 󰦕}"      # removes ' 󰦕' if present at the end
ssid="${ssid%"${ssid##*[![:space:]]}"}"  # trims trailing whitespace
[ -z "$ssid" ] && (sed -i "s/^$KEY=.*/$KEY=0/" "$STATE_FILE") && exit 0

# ---------------------------
# 4. Determine if known
# ---------------------------
nid=$(wpa_cli -i "$interface" list_networks \
  | awk -F'\t' -v ss="$ssid" 'NR>1 && $2==ss {print $1}')
# ---------------------------
# 5. If known → connect directly
# ---------------------------
#
if [ -n "$nid" ]; then
  wpa_cli -i "$interface" enable_network "$nid" >/dev/null
  wpa_cli -i "$interface" select_network "$nid" >/dev/null

  # Set loading state and monitor connection in background
  sed -i "s/^$KEY=.*/$KEY=1/" "$STATE_FILE"

  # Monitor connection in background (same as new network)
  (
    # Wait up to 10 seconds for successful connection
    for i in {1..10}; do
      STATUS=$(wpa_cli -i "$interface" status | grep wpa_state | cut -d= -f2)
      if [ "$STATUS" = "COMPLETED" ]; then
        wpa_cli -i "$interface" save_config >/dev/null
        notify-send "WiFi" "Connected to $ssid"
        sed -i "s/^$KEY=.*/$KEY=0/" "$STATE_FILE"
        exit 0
      fi
      sleep 1
    done

    # Connection failed
    notify-send "WiFi" "󱛅 ${ssid} connection timeout"
    sed -i "s/^$KEY=.*/$KEY=0/" "$STATE_FILE"
  ) &

  exit 0
fi

# --- Ask for password ---
password=$(rofi -dmenu -password -p "Password for $ssid")
[ -z "$password" ] && (sed -i "s/^$KEY=.*/$KEY=0/" "$STATE_FILE") && exit

# Create new network
nid=$(wpa_cli -i "$interface" add_network | awk '{print $1}')

# Set SSID and PSK
wpa_cli -i "$interface" set_network "$nid" ssid "\"$ssid\"" >/dev/null
wpa_cli -i "$interface" set_network "$nid" psk "\"$password\"" >/dev/null

# Enable and save
wpa_cli -i "$interface" enable_network "$nid" >/dev/null

# Set loading state and monitor connection in background
sed -i "s/^$KEY=.*/$KEY=1/" "$STATE_FILE"

# Monitor connection in background
(
  # Wait up to 10 seconds for successful connection
  for i in {1..10}; do
    STATUS=$(wpa_cli -i "$interface" status | grep wpa_state | cut -d= -f2)
    if [ "$STATUS" = "COMPLETED" ]; then
      # SUCCESS → save config permanently
      wpa_cli -i "$interface" save_config >/dev/null
      wpa_cli -i "$interface" select_network "$nid" >/dev/null
      notify-send "WiFi" "Connected to $ssid"
      sed -i "s/^$KEY=.*/$KEY=0/" "$STATE_FILE"
      exit 0
    fi
    sleep 1
  done

  # Connection failed
  notify-send "WiFi" "󱛅 ${ssid} error"
  wpa_cli -i "$interface" remove_network "$nid" >/dev/null
  sed -i "s/^$KEY=.*/$KEY=0/" "$STATE_FILE"
) &
