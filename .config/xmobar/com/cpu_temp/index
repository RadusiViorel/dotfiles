#!/usr/bin/env bash

source "${HOME}/.config/xmobar/scripts/check_dependency"
check_dependency "sensors"

COM="${HOME}/.config/xmobar/com/cpu_temp"
[[ -n "$1" ]] && STATE_FILE="${HOME}/.config/xmobar/scripts/state" && source "${STATE_FILE}"

source "${HOME}/.config/xmobar/scripts/cache"
source "${HOME}/.config/xmobar/scripts/page/index" 2

# Cache sensors output for 3 seconds (temperature doesn't change that fast)
temp=$(cache_cmd "sensors" 3 sensors | awk '/acpitz-acpi-0/ {flag=1} flag && /temp1/ {gsub(/[+°C]/,"",$2); print $2; exit}')
temp_int=${temp%.*}  # Convert to integer for comparison

thresholds=(50 70 85 95)
tempicons=(   "󰈅")
tempcolors=($COLOR_OK $COLOR_WARNING $COLOR_DANGER $COLOR_CRITIC)
tempcolor=${tempcolors[-1]}
tempicon=${tempicons[-1]}

for i in "${!thresholds[@]}"; do
  if (( temp_int < thresholds[i] )); then
    tempcolor=${tempcolors[i]}
    tempicon=${tempicons[i]}
    break
  fi
done

case "$1" in
    top) ${COM}/actions/htop ;;
    *) ;;
esac

echo "<fc=${tempcolor}>${tempicon} ${temp}°</fc>"
