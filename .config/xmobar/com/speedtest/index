#!/usr/bin/env bash

COM="${HOME}/.config/xmobar/com/speedtest"
[[ -n "$1" ]] && STATE_FILE="${HOME}/.config/xmobar/scripts/state" && source "${STATE_FILE}"
source "${HOME}/.config/xmobar/scripts/page/index" 2

if ! command -v speedtest >/dev/null 2>&1; then
  echo "Warning: speedtest is not installed or not in PATH."
  exit 1
fi

now=$(date +%s)

source "${HOME}/.config/xmobar/scripts/state_loader"
state_init "speedtest_isp" "UNKNOWN"
state_init "speedtest_up" 0
state_init "speedtest_down" 0
state_init "speedtest_timestamp" $((now - 3601))
state_init "speedtest_loading" 0
state_init "speedtest_spinner" 0

case "$1" in
  show) ${COM}/actions/show \
    --isp="${speedtest_isp}" \
    --down=${speedtest_down} \
    --up=${speedtest_up}     \
    --timestamp=${speedtest_timestamp} ;;

  run) ${COM}/actions/run          \
    --STATE_FILE=${STATE_FILE}     \
    --ISP_KEY=speedtest_isp        \
    --UP_KEY=speedtest_up          \
    --DOWN_KEY=speedtest_down      \
    --TIMESTAMP_KEY=speedtest_timestamp \
    --LOADING_KEY=speedtest_loading ;;
  *) ;;
esac

if (( speedtest_loading == 1 )); then
  spinner_icons=(⠋ ⠙ ⠹ ⠸ ⠼ ⠴ ⠦ ⠧ ⠇ ⠏)
  idx=$(( ( speedtest_spinner + 1 ) % ${#spinner_icons[@]} ))
  state_update "speedtest_spinner" "$idx"
  echo "<fc=${COLOR_INFO}>${spinner_icons[$idx]} Testing 󰓅</fc>"
  exit 0
fi

echo "<fc=${COLOR_WHITE}>󰾆</fc>"
