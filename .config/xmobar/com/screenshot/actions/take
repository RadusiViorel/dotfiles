#!/usr/bin/env bash
set -e

# Parse named parameters
for arg in "$@"; do
  case $arg in
    --DESTINATION=*) DESTINATION="${arg#*=}" ;;
    --edit=*)        edit="${arg#*=}" ;;
    *) echo "Unknown argument: $arg" ; exit 1 ;;
  esac
done

mkdir -p "$DESTINATION"
TMP_FILE="$DESTINATION/tmp-$$.png"

MODE=$(printf "Full\nSection" | rofi -dmenu -i -p "Screenshot type")
[ -z "$MODE" ] && exit 0

# 0. Delay selection
DELAY=$(printf "No delay\n2\n4\n10" | rofi -dmenu -i -p "Delay (seconds)")
[ -z "$DELAY" ] && exit 0

COMMAND=(scrot)

if [[ "$DELAY" != "No delay" ]]; then
  COMMAND+=(--delay "$DELAY")
fi

if [[ "$MODE" == "Section" ]]; then
  COMMAND+=(--select)
else
  # Get monitors with index + name
  mapfile -t MONS < <(xrandr --listmonitors | tail -n +2)

  if (( ${#MONS[@]} > 1 )); then
    # Build display list: "0: eDP-1"
    MENU=()
    for m in "${MONS[@]}"; do
      IDX=$(echo "$m" | awk '{print $1}' | tr -d ':')
      NAME=$(echo "$m" | awk '{print $4}')
      MENU+=("$IDX: $NAME")
    done

    CHOICE=$(printf "%s\n" "${MENU[@]}" | rofi -dmenu -i -p "Monitor")
    [ -z "$CHOICE" ] && exit 0

    MON_IDX=$(echo "$CHOICE" | cut -d: -f1)
    COMMAND+=(--monitor "$MON_IDX")
  fi
fi

# Take screenshot
"${COMMAND[@]}" "$TMP_FILE"

if [[ "$edit" -eq 1 ]]; then
  swappy -f "$TMP_FILE" -o "$TMP_FILE"
fi

TS=$(date +"%Y-%m-%d_%H-%M-%S")
OUT="$DESTINATION/screenshot_$TS.png"

cp "$TMP_FILE" "$OUT"

xclip -selection clipboard -t image/png -i "$TMP_FILE"

rm -f "$TMP_FILE"

notify-send "Screenshot" "screenshot_$TS.png ïƒª"
