#!/usr/bin/env bash

# Vars/state already exported from scripts/bar
source "${HOME}/.config/xmobar/scripts/state_loader"
source "${HOME}/.config/xmobar/scripts/page/index" 2

DESTINATION="${HOME}/youtube_dl"

COM="${HOME}/.config/xmobar/com/yt_dl"
STATE_FILE="${HOME}/.config/xmobar/scripts/state"

# Initialize state keys if needed
state_init "yt_type" "mp4"
state_init "yt_loading" 0
state_init "yt_spinner" 0


# If action is called, re-source state to get current values
if [[ -n "$1" ]]; then
  source "${STATE_FILE}"
fi

if ! command -v yt-dlp >/dev/null 2>&1; then
  echo "Warning: yt-dlp is not installed or not in PATH."
  exit 1
fi

if ! command -v ffmpeg >/dev/null 2>&1; then
  echo "Warning: ffmpeg is not installed or not in PATH."
  exit 1
fi

case "$1" in
  download) ${COM}/actions/download \
    --STATE_FILE=${STATE_FILE}      \
    --destination=${DESTINATION}    \
    --type=${yt_type}               \
    --LOADING_KEY=yt_loading ;;

  toggle) ${COM}/actions/toggle  \
     --STATE_FILE=${STATE_FILE}  \
     --KEY=yt_type               \
     --value=${yt_type}
     # Re-source state after action to get updated value
     source "${STATE_FILE}" ;;
  *) ;;
esac

if (( yt_loading == 1 )); then
  spinner_icons=(⠋ ⠙ ⠹ ⠸ ⠼ ⠴ ⠦ ⠧ ⠇ ⠏)
  idx=$(( ( yt_spinner + 1 ) % ${#spinner_icons[@]} ))
  state_update "yt_spinner" "$idx"
  echo "<fc=${COLOR_INFO}>${spinner_icons[$idx]} Downloading 󰦗</fc>"
  exit 0
fi

color=$([[ $yt_type == 'mp4' ]] && echo "${COLOR_DANGER}" || echo "${COLOR_WARNING}")
echo "<fc=${color}>󰗃</fc>"
