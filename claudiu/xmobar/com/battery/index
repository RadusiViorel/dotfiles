#!/usr/bin/env bash

# Vars/state already exported from scripts/bar
source "${HOME}/.config/xmobar/scripts/cache"
source "${HOME}/.config/xmobar/scripts/state_loader"
source "${HOME}/.config/xmobar/scripts/page/index" 1

COM="${HOME}/.config/xmobar/com/battery"
STATE_FILE="${HOME}/.config/xmobar/scripts/state"

now=$(date +%s)
CACHE_TTL=80   # seconds

# Initialize state keys if needed
state_init "battery_level_icon" 0
state_init "battery_show_time" 0
state_init "battery_info" ""
state_init "battery_timestamp" $((now - 81))


# If action is called, re-source state to get current values
if [[ -n "$1" ]]; then
  source "${STATE_FILE}"
fi

if ! command -v acpi >/dev/null 2>&1; then
  echo "Warning: acpi is not installed or not in PATH."
  exit 1
fi

# Refresh cache if older than CACHE_TTL
if (( now - battery_timestamp >= CACHE_TTL )); then
  battery_info="$(acpi -b 2>/dev/null)"
  state_update "battery_info" "\"$battery_info\""
  state_update "battery_timestamp" "$now"
fi

# If acpi output does NOT contain "Battery", then exit
echo "$battery_info" | grep -q "Battery" || exit 0

state=$(echo "$battery_info" | awk -F'[,: ]+' '{print $3}')
level=$(echo "$battery_info" | awk -F'[,% ]+' '{print $4}')
time=$(echo "$battery_info"  | awk '{for(i=1;i<=NF;i++){if($i~/[0-9][0-9]:[0-9][0-9]:[0-9][0-9]/) print $i}}')

thresholds=(10 33 66 85 95)
icons=("󰢟" "󱊤" "󱊥" "󱊦" "󰂅")

case "$1" in
  show_time) ${COM}/actions/show_time \
    --value=${battery_show_time}      \
    --STATE_FILE=${STATE_FILE}        \
    --KEY=battery_show_time
    # Re-source state after action to get updated value
    source "${STATE_FILE}" ;;
  *) ;;
esac

if [[ "$state" == "Full" ]]; then
  echo ""
  exit 0
fi

if [[ "$state" == "Not" ]]; then
  echo $level
  exit 0;
fi

if [[ "$state" == "Charging" ]]; then

  usable_icons=()
  for i in "${!thresholds[@]}"; do
    if [[ "$level" -le "${thresholds[$i]}" ]]; then
        usable_icons+=("${icons[$i]}")
    fi
  done

  # Safety fallback
  [[ ${#usable_icons[@]} -eq 0 ]] && usable_icons=("${icons[$((${#icons[@]} - 1))]}")

  idx=$(( (battery_level_icon + 1) % ${#usable_icons[@]} ))
  state_update "battery_level_icon" "$idx"

  timercolor="${COLOR_OK}"
  icon="${usable_icons[$idx]} <fc=$timercolor>${level}󰏰</fc>"
  [[ $battery_show_time == 1 ]] && icon="$icon  <fc=$timercolor> $time </fc>"
  echo "${icon}"
  exit 0
fi

# Otherwise output normal code
if [[ "$state" == "Discharging" ]]; then
  thresholds=(10 33 66)
  icons=("󰂎" "󱊡" "󱊢" "󱊣")
  timercolors=($COLOR_CRITIC $COLOR_DANGER $COLOR_WARNING $COLOR_OK)

  icon="${icons[-1]}  ${level}󰏰"
  timercolor=${timercolors[-1]}
  for i in "${!thresholds[@]}"; do
    if (( level < thresholds[i] )); then
      icon="${icons[i]} ${level}󰏰"
      timercolor=${timercolors[i]}
      break
    fi
  done
else
  icon="󰂃"
fi

output=$([[ $level -le ${thresholds[1]} ]] && echo "<fc=$timercolor>$icon</fc>" || echo ${icon} )
output=$([[ $battery_show_time -eq 1 ]] && echo $output || echo "$output <fc=$timercolor> $time </fc>" )
echo "${output}"
