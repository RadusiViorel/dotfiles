#!/usr/bin/env bash

# Vars/state already exported from scripts/bar
source "${HOME}/.config/xmobar/scripts/cache"
source "${HOME}/.config/xmobar/scripts/page/index" 2

# Cache top and free outputs for 2 seconds (system stats don't need per-second updates)
cpu_idle=$(cache_cmd "top" 2 top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/")
cpu_usage=$(awk "BEGIN {printf \"%.1f\", 100 - $cpu_idle}")
cpu_int=${cpu_usage%.*}

# Get RAM usage in one awk call instead of multiple free invocations
ram_used_mb=$(cache_cmd "free" 2 free -m | awk '/^Mem:/ {print $3}')
ram_used_gb=$(awk "BEGIN {printf \"%.1f\", $ram_used_mb/1024}")

# CPU color thresholds
if (( cpu_int < 30 )); then
  cpu_color=$COLOR_WHITE
elif (( cpu_int < 60 )); then
  cpu_color=$COLOR_WARNING
elif (( cpu_int < 90 )); then
  cpu_color=$COLOR_DANGER
else
  cpu_color=$COLOR_CRITIC
fi

# RAM color thresholds (in GB)
ram_float=$(awk "BEGIN {print $ram_used_gb}")
if awk "BEGIN {exit !($ram_float < 4.0)}"; then
  ram_color=$COLOR_WHITE
elif awk "BEGIN {exit !($ram_float < 6.0)}"; then
  ram_color=$COLOR_WARNING
elif awk "BEGIN {exit !($ram_float < 10.0)}"; then
  ram_color=$COLOR_DANGER
else
  ram_color=$COLOR_DANGER
fi

# Nerd Font icons
cpu_icon="󰻠"  # CPU chip icon
ram_icon="󰍛"  # RAM/memory icon

# Format output: CPU icon + percentage / RAM icon + usage
echo "<fc=${cpu_color}>${cpu_icon} ${cpu_int}%</fc> <fc=${COLOR_MUTE}>󰜥</fc> <fc=${ram_color}>${ram_icon} ${ram_used_gb}G</fc>"
