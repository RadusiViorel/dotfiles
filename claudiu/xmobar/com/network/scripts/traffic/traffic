#!/usr/bin/env bash

# Parse named parameters
for arg in "$@"; do
  case $arg in
    --interface=*) interface="${arg#*=}" ;;
    *) echo "Unknown argument: $arg" ; exit 1 ;;
  esac
done

source "${HOME}/.config/xmobar/scripts/vars"
COM="${HOME}/.config/xmobar/com/network"
VALUE_FILE="${COM}/scripts/traffic/value"

read rx tx < <(
  awk -v i="$interface" '$1 == i ":" {print $2, $10}' /proc/net/dev
)

now_ms=$(date +%s%3N)

if [[ -f "$VALUE_FILE" ]]; then
  read last_rx last_tx last_ms last_rx_rate last_tx_rate last_rx_unit last_tx_unit last_color < "$VALUE_FILE"

  # ✅ THIS WILL NOW TRIGGER
  if (( now_ms - last_ms < 2000 )); then
    echo "<fc=${last_color}>   ${last_rx_rate} ${last_rx_unit} /   ${last_tx_rate} ${last_tx_unit}</fc>"
    exit 0
  fi

  dt_ms=$((now_ms - last_ms))
  (( dt_ms > 0 )) || dt_ms=1

  rx_mb=$(awk "BEGIN {print ($rx-$last_rx)/1024/1024/($dt_ms/1000)}")
  tx_mb=$(awk "BEGIN {print ($tx-$last_tx)/1024/1024/($dt_ms/1000)}")
else
  rx_mb=0
  tx_mb=0
fi

color=${COLOR_INFO}

# --- Auto unit selection ---
if awk "BEGIN {exit !($rx_mb >= 1024)}"; then
  rx_rate=$(awk "BEGIN {printf \"%.2f\", $rx_mb/1024}")
  rx_unit="GB"
  color=${COLOR_OK}
else
  rx_rate=$(awk "BEGIN {printf \"%.2f\", $rx_mb}")
  rx_unit="MB"
fi

if awk "BEGIN {exit !($tx_mb >= 1024)}"; then
  tx_rate=$(awk "BEGIN {printf \"%.2f\", $tx_mb/1024}")
  tx_unit="GB"
  color=${COLOR_OK}
else
  tx_rate=$(awk "BEGIN {printf \"%.2f\", $tx_mb}")
  tx_unit="MB"
fi

echo "$rx $tx $now_ms $rx_rate $tx_rate $rx_unit $tx_unit $color" > "$VALUE_FILE"

echo "<fc=${color}>   ${rx_rate} ${rx_unit} /   ${tx_rate} ${tx_unit}</fc>"
