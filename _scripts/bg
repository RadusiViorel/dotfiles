#!/usr/bin/env bash
set -euo pipefail

# --- Configuration ---
WALLPAPER_DIR="${1:-$HOME/wallpapers}"  # pass dir as first arg or default
EXTENSIONS=(jpg jpeg png gif bmp webp)           # add/remove as needed
FEH_OPTS="--bg-fill"                             # change to --bg-scale, --bg-center, etc.

# --- Build find command safely (handles spaces) ---
# We'll build an array and use -print0 to be safe with filenames.
find_cmd=(find "$WALLPAPER_DIR" -type f \( )
for ext in "${EXTENSIONS[@]}"; do
  find_cmd+=( -iname "*.${ext}" -o )
done
# remove the trailing "-o" and close the parenthesis
unset 'find_cmd[${#find_cmd[@]}-1]'
find_cmd+=( \) -print0 )

# --- Run find and read null-delimited results into an array ---
mapfile -d '' -t images < <("${find_cmd[@]}")

# If no images found, exit with message
if (( ${#images[@]} == 0 )); then
  echo "No images found in '$WALLPAPER_DIR' for extensions: ${EXTENSIONS[*]}" >&2
  exit 1
fi

# --- Pick a random image ---
# If 'shuf' is available prefer it (safer for large arrays). Otherwise fallback to $RANDOM.
if command -v shuf >/dev/null 2>&1; then
  chosen=$(printf '%s\n' "${images[@]}" | shuf -n1)
else
  idx=$(( RANDOM % ${#images[@]} ))
  chosen="${images[$idx]}"
fi

# --- Apply with feh ---
feh $FEH_OPTS -- "${chosen}"

# For scripts that should not leave a zero exit if feh fails:
exit 0
