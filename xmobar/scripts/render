#!/usr/bin/env bash
source "${HOME}/.config/xmobar/scripts/vars"

for arg in "$@"; do
  case $arg in
    --sep=*) custom_sep="${arg#*=}" ;;
    *) echo "Unknown argument: $arg" ; exit 1 ;;
  esac
done

xmobar_actions() {
  local script="$1"
  shift

  # Get the rendered text once
  local text
  text="$("$script")" || return 0

  # If text is empty (or only whitespace), output nothing
  [[ -z ${text//[[:space:]]/} ]] && return 0
  sep="$([[ -z ${custom_sep//[[:space:]]/} ]] && printf '%s' "$SEP" || printf '%s' "$custom_sep")"

  # Wrap text in nested <action> tags in REVERSE order
  local i
  for ((i=$#; i>0; i--)); do
    local action="${!i}"
    local button="${action%%:*}"
    local args="${action#*:}"
    text="<action=\`$script $args\` button=$button>$text</action>"
  done

  echo "${text} $sep "
}
