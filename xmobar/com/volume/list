#!/usr/bin/env bash

parse_wpctl_sinks() {
    local sinks=()
    local line default volume id name clean_line

    while read -r line; do
        # Trim leading spaces
        line="${line#"${line%%[![:space:]]*}"}"

        # Start/stop parsing sinks
        [[ "$line" == "Sinks:" ]] && section_active=1 && continue
        [[ -z "$line" ]] && section_active=0
        [[ "$section_active" != 1 ]] && continue

        default=false
        [[ "$line" == \** ]] && default=true

        volume=0
        if [[ "$line" =~ \[vol:[[:space:]]*([0-9]+\.[0-9]+) ]]; then
            vol="${BASH_REMATCH[1]}"
            volume=$(awk "BEGIN {printf \"%d\", $vol*100}")
        fi

        # Remove leading *, trim spaces
        clean_line="${line#\*}"
        clean_line="${clean_line#"${clean_line%%[![:space:]]*}"}"

        # Split id and name
        id="${clean_line%%.*}"
        rest="${clean_line#*.}"
        name="${rest%%[[]*}"
        name="$(echo "$name" | xargs)"

        # Store as a Bash "record" string: id|name|default|volume
        sinks+=("$id|$name|$default|$volume")

    done < <(wpctl status | sed 's/[├─│└]//g')

    # Print all sinks, one per line
    printf '%s\n' "${sinks[@]}"
}

# Example usage:
sinks=$(parse_wpctl_sinks)
echo "$sinks"

