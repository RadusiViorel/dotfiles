#!/usr/bin/env bash

# Parse named parameters
for arg in "$@"; do
  case $arg in
    --OUTPUT_FILE=*) OUTPUT_FILE="${arg#*=}" ;;
    *) echo "Unknown argument: $arg" ; exit 1 ;;
  esac
done

NOW=$(date +%s)

speedtest-cli 2>/dev/null | awk -v now="$NOW" '
/^Testing from/ {
  sub(/^Testing from /,""); sub(/ \(.*/, ""); isp=$0
}
/^Download:/ {down=sprintf("%.2f", $2/8)}
/^Upload:/   {up=sprintf("%.2f", $2/8)}
END {
  if (down && up)
    printf "%s|%s|%s|%d\n", isp, down, up, now
}' > "$OUTPUT_FILE"
